<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registrar / Editar Producto</title>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 font-poppins">

<!-- Header -->
<div class="fixed top-0 w-full z-50 bg-white shadow-md flex items-center justify-between px-6 py-4">
    <div class="flex items-center gap-3 text-lg font-semibold text-gray-800">
        <i class="fa-solid fa-boxes-stacked text-blue-500"></i>
        Panel de Administraci√≥n - Tecnolog√≠a
    </div>
	<div class="text-gray-700">
	        Bienvenido: <span class="font-semibold" th:text="${adminNombre}">Admin</span>
			<div class="text-gray-600 text-sm" id="reloj">00/00/0000 00:00</div>
	    </div>
</div>

<div class="flex pt-20 min-h-screen">

	<!-- SIDEBAR -->
	    <aside class="w-64 bg-gray-800 text-gray-200 fixed top-20 left-0 h-[calc(100vh-5rem)] shadow-lg">
	        <nav class="flex flex-col mt-4 gap-1 px-3">
	            <a th:href="@{/PaginaAdmin/PanelAdmin}"
	               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-700">
	                <i class="fa fa-chart-line text-blue-400"></i> Dashboard
	            </a>

	            <a th:href="@{/mantenimientoProductos/lista}"
	               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-600 mt-auto">
	                <i class="fa fa-plus text-blue-400"></i> Productos
	            </a>

	            <a th:href="@{/mantenimientoProductos/nuevo}"
	               class="flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-700 text-white">
	                <i class="fa fa-box text-blue-400"></i> Nuevo Producto
	            </a>

	            <a th:href="@{/logout}"
	               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-600 mt-auto">
	                <i class="fa fa-right-from-bracket text-red-400"></i> Cerrar sesi√≥n
	            </a>
	        </nav>
	    </aside>

    <!-- Contenido -->
    <div class="ml-60 flex-1 p-8">
        <div class="max-w-4xl mx-auto">

            <div class="card shadow-lg rounded-2xl">
                <div class="card-header bg-gradient-to-r from-blue-500 to-blue-700 text-white text-center py-4">
                    <h3 th:text="${producto.idProducto == null} ? 'üì¶ Nuevo Producto' : '‚úèÔ∏è Editar Producto'"
                        class="text-xl font-semibold"></h3>
                </div>

                <div class="card-body p-6">

                    <form th:action="@{/mantenimientoProductos/guardar}"
                          th:object="${producto}"
                          method="post"
                          enctype="multipart/form-data">

                        <input type="hidden" th:field="*{idProducto}"/>

                        <!-- Nombre -->
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" th:field="*{nombre}" class="form-control" required>
                        </div>

                        <!-- Descripci√≥n -->
                        <div class="mb-3">
                            <label class="form-label">Descripci√≥n</label>
                            <textarea th:field="*{descripcion}" rows="3" class="form-control"></textarea>
                        </div>
						
						<!-- Especificaciones T√©cnicas -->
						<div class="mb-3">
						    <label class="form-label">Especificaciones T√©cnicas</label>
							<textarea name="especificacionesInput"
							          class="form-control"
							          rows="5"
							          th:text="${especificacionesInput}"
							          placeholder="Frecuencia: 3200 MHz&#10;Capacidad: 16GB&#10;Tipo: DDR4&#10;Latencia: CL16"></textarea>
						    <small class="text-muted">
						        Escribe una especificaci√≥n por l√≠nea usando el formato: Atributo: Valor
						    </small>
						</div>
						
                        <!-- Precio y Stock -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Precio (S/)</label>
                                <input type="number" step="0.01" th:field="*{precio}" class="form-control" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Stock</label>
                                <input type="number" th:field="*{stock}" min="0" class="form-control" required>
                            </div>
                        </div>

						<!-- Categor√≠a -->
						<div class="mb-3">
						    <label class="form-label">Categor√≠a</label>

						    <select class="form-select"
						            id="categoriaSelect"
						            name="categoriaPadre"
						            required>

						        <option value="">-- Seleccione --</option>

								<option th:each="c : ${categorias}"
								        th:value="${c.idCategoria}"
								        th:text="${c.nombre_Categoria}"
								        th:selected="${producto.categoria != null 
								                      and (producto.categoria.idCategoria == c.idCategoria 
								                           or producto.categoria.categoriaPadre?.idCategoria == c.idCategoria)}">
								</option>
						    </select>
						</div>

						<!-- Subcategor√≠a -->
						<div class="mb-3" id="subcategoriaDiv" style="display:none;">
						    <label class="form-label">Subcategor√≠a</label>

							<select class="form-select"
							        id="subcategoriaSelect"
							        name="categoria.idCategoria"
							        th:data-selected="${producto.categoria != null ? producto.categoria.idCategoria : ''}">
						        <option value="">-- Seleccione subcategor√≠a --</option>
						    </select>
						</div>
						
                        <!-- Estado -->
						<div class="mb-3" th:if="${producto.idProducto != null}">
						    <label class="form-label">Estado</label>
						    <select th:field="*{estado}" class="form-select">
						        <option value="ACTIVO">ACTIVO</option>
						        <option value="INACTIVO">INACTIVO</option>
						    </select>
						</div>

                        <!-- Imagen -->
                        <div class="mb-3">
                            <label class="form-label">Imagen actual</label>
                            <div th:if="${producto.imagen != null}">
                                <img th:src="@{/img/{img}(img=${producto.imagen})}"
                                     class="img-thumbnail mb-2"
                                     style="max-width: 150px;">
                            </div>

                            <label class="form-label mt-2">Subir / Cambiar imagen</label>
                            <input type="file" name="imagenArchivo" class="form-control">
                        </div>

                        <!-- Bot√≥n -->
                        <div class="text-center mt-4">
                            <button class="btn btn-primary btn-lg px-5">
                                <i class="fa-solid fa-floppy-disk"></i> Guardar
                            </button>
                        </div>

                    </form>

                    <!-- Mensajes -->
                    <div th:if="${msg == 'ok'}" class="alert alert-success mt-4 text-center">
                        ‚úÖ Producto guardado correctamente
                    </div>

                    <div th:if="${msg == 'exception'}" class="alert alert-danger mt-4 text-center">
                        ‚ùå Error al guardar el producto
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

</body>
<script>

	function actualizarReloj() {
	    const ahora = new Date();
	    const dia = String(ahora.getDate()).padStart(2, '0');
	    const mes = String(ahora.getMonth() + 1).padStart(2, '0'); // Enero = 0
	    const anio = ahora.getFullYear();
	    const hora = String(ahora.getHours()).padStart(2, '0');
	    const minutos = String(ahora.getMinutes()).padStart(2, '0');
	    const segundos = String(ahora.getSeconds()).padStart(2, '0');
	    document.getElementById('reloj').innerText = `${dia}/${mes}/${anio} ${hora}:${minutos}:${segundos}`;
	}

	// Actualiza cada segundo
	setInterval(actualizarReloj, 1000);
	actualizarReloj(); 
	
	
	// =========================
	  // CATEGOR√çAS DIN√ÅMICAS
	  // =========================

	  function cargarSubcategorias(categoriaId, subcategoriaSeleccionada = null) {

	      let subcategoriaDiv = document.getElementById("subcategoriaDiv");
	      let subcategoriaSelect = document.getElementById("subcategoriaSelect");
	      let categoriaSelect = document.getElementById("categoriaSelect");

	      if (!categoriaId) {
	          subcategoriaDiv.style.display = "none";
	          subcategoriaSelect.removeAttribute("required");
	          categoriaSelect.setAttribute("required", "required");
	          return;
	      }

	      fetch("/mantenimientoProductos/subcategorias/" + categoriaId)
	          .then(response => response.json())
	          .then(data => {

	              subcategoriaSelect.innerHTML =
	                  '<option value="">-- Seleccione subcategor√≠a --</option>';

	              if (data.length > 0) {

	                  subcategoriaDiv.style.display = "block";

	                  subcategoriaSelect.setAttribute("required", "required");
	                  categoriaSelect.removeAttribute("required");

	                  data.forEach(sub => {

	                      let option = document.createElement("option");
	                      option.value = sub.idCategoria;
	                      option.text = sub.nombre_Categoria;

	                      // üî• Si estamos editando y coincide el ID
	                      if (subcategoriaSeleccionada &&
	                          sub.idCategoria == subcategoriaSeleccionada) {
	                          option.selected = true;
	                      }

	                      subcategoriaSelect.appendChild(option);
	                  });

	              } else {

	                  subcategoriaDiv.style.display = "none";
	                  subcategoriaSelect.removeAttribute("required");
	                  categoriaSelect.setAttribute("required", "required");
	              }
	          });
	  }


	  // Cuando cambia la categor√≠a (modo crear)
	  document.getElementById("categoriaSelect")
	      .addEventListener("change", function () {
	          cargarSubcategorias(this.value);
	      });


	  //  Cuando la p√°gina carga (modo editar)
	  document.addEventListener("DOMContentLoaded", function () {

	      let categoriaActual = document.getElementById("categoriaSelect").value;

	      // Si est√°s editando y el producto ya tiene subcategor√≠a
	      let subcategoriaActual = document.getElementById("subcategoriaSelect").dataset.selected;

	      if (categoriaActual) {
	          cargarSubcategorias(categoriaActual, subcategoriaActual);
	      }
	  });
	
</script>
</html>
