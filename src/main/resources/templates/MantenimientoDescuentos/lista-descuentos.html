<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Lista de Promociones - Panel Admin</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">

    <link rel="stylesheet" th:href="@{/css/lista-productos.css}">
</head>

<body class="bg-gray-100 font-[Poppins]">

<!-- HEADER -->
<div class="fixed top-0 w-full z-50 bg-white shadow-md flex items-center justify-between px-6 py-4">
    <div class="flex items-center gap-3 text-lg font-semibold text-gray-800">
        <i class="fa-solid fa-boxes-stacked text-blue-600"></i>
        Panel de Administración - Tienda Tecnológica
    </div>
    <div class="text-gray-700">
        Bienvenido: <span class="font-semibold" th:text="${adminNombre}">Admin</span>
        <div class="text-gray-600 text-sm" id="reloj">00/00/0000 00:00</div>
    </div>
</div>

<!-- LAYOUT -->
<div class="flex pt-20 min-h-screen">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-gray-800 text-gray-200 fixed top-20 left-0 h-[calc(100vh-5rem)] shadow-lg">
        <nav class="flex flex-col mt-4 gap-1 px-3">
            <a th:href="@{/PaginaAdmin/PanelAdmin}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-700">
                <i class="fa fa-chart-line text-blue-400"></i> Dashboard
            </a>

            <a th:href="@{/mantenimientoProductos/lista}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-700 text-white">
                <i class="fa fa-box text-blue-400"></i> Productos
            </a>

            <a th:href="@{/mantenimientoProductos/nuevo}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-700">
                <i class="fa fa-plus text-blue-400"></i> Nuevo Producto
            </a>
			
			<a th:href="@{/admin/pedidos}"
			              class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-700">
			               <i class="fa-solid fa-shopping-cart text-blue-400"></i> Pedido
			           </a>
            <a th:href="@{/mantenimientoDescuentos/listaDescuentos}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg bg-gray-700 ">
                <i class="fa-solid fa-tag text-blue-400"></i>Descuentos
            </a>

            <a th:href="@{/mantenimientoPromociones/listaPromociones}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg b hover:bg-gray-700 text-center">
                <i class="fa-solid fa-bullhorn text-blue-400"></i> Promociones
            </a>

            <a th:href="@{/logout}"
               class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-red-600 mt-auto">
                <i class="fa fa-right-from-bracket text-red-400"></i> Cerrar sesión
            </a>
        </nav>
    </aside>

    <!-- CONTENIDO -->
    <main class="ml-64 flex-1 p-8">

        <h2 class="text-3xl font-semibold text-gray-800 mb-6 text-center" id="titulo">
            Gestión de Descuentos
        </h2>

        <!-- CONTADORES -->
        <div class="grid grid-cols-3 gap-6 mb-6">
            <div class="bg-white shadow rounded-lg p-4 text-center">
                <h5 class="text-gray-500">Descuentos en Curso</h5>
                <p class="text-3xl font-bold text-green-600" th:text="${descuentosCurso}">0</p>
            </div>

            <div class="bg-white shadow rounded-lg p-4 text-center">
                <h5 class="text-gray-500">Descuentos Fuera de Vigencia</h5>
                <p class="text-3xl font-bold text-red-600" th:text="${descuentosTotal-descuentosCurso}">0</p>
            </div>

            <div class="bg-white shadow rounded-lg p-4 text-center">
                <h5 class="text-gray-500">Total</h5>
                <p class="text-3xl font-bold text-blue-600" th:text="${descuentosTotal}">0</p>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="grid grid-cols-[auto_1fr_auto] items-center mb-3 gap-3">
            <div class="mb-1">
                <label class="form-label fw-bold">Promociones</label>
                <select class="form-select" name="promocion.idPromocion"  onchange="redirigirPromocion(this)"  id="comboPromos">

                    <option th:value="Todos"
                            th:text="TODOS">
                    </option>

                    <option th:each="p : ${listapromociones}"
                            th:value="${p.nombrePromo}"
                            th:text="${p.nombrePromo}">
                    </option>

                </select>

            </div>

            <div class="flex justify-center gap-3">
                <a th:href="@{/mantenimientoDescuentos/listaDescuentos}"
                   class="btn btn-secondary"
                   th:classappend="${estadoActual == null} ? 'active' : ''">
                    Todos
                </a>

                <a th:href="@{/mantenimientoDescuentos/listaDescuentos(estado='en-curso')}"
                   class="btn btn-success"
                   th:classappend="${estadoActual == 'ACTIVO'} ? 'active' : ''">
                    Vigentes
                </a>

                <a th:href="@{/mantenimientoDescuentos/listaDescuentos(estado='no-en-curso')}"
                   class="btn btn-danger"
                   th:classappend="${estadoActual == 'INACTIVO'} ? 'active' : ''">
                    No Vigentes
                </a>

                <!-- BOTON PARA ABRIR -->
                <a onclick="document.getElementById('dlgProductos').showModal()" class="btn btn-info text-white">
                    Aplicar Descuento Multiple
                </a>

                <!-- ===== DIALOG ===== -->
                <dialog id="dlgProductos">

                    <h3>Buscar Productos:</h3>

                    <!-- BUSCADOR -->
                    <div class="buscador">

                        <input type="text" placeholder="Buscar producto..."  onkeyup="buscarProductos(this.value)">

                    </div>

                    <!-- LISTAS -->
                    <div class="listas">

                        <div class="lista">
                            <h4>Coincidencias</h4>
                            <ul class="resultados">

                            </ul>
                        </div>

                        <div class="lista">
                            <h4>Seleccionados</h4>
                            <ul class="seleccionados">

                            </ul>
                        </div>

                    </div>
                    <h3 class="mt-4">Elige una promo o crea una nueva:</h3>
                    <div class="row justify-content-center align-items-center g-3 mb-3 abierta" id="bloquePromo">

                        <div class="col-4">
                            <select id="selectPromociones" class="form-select">
                                <option value="">Elija una promoción</option>
                            </select>
                        </div>

                        <div class="col-3 text-center">
                            <button class="btn btn-success w-100" id="buttonNuevaPromo">
                                Nueva promoción
                            </button>
                        </div>

                    </div>
                    <div class="row justify-content-center align-items-center g-3 mb-3 d-none" id="bloqueNuevaPromo">

                        <div class="col-4">
                            <input type="text" placeholder="Escriba la nueva promocion"  class="form-control" name="promo-nueva" id="promoNueva">
                        </div>

                        <div class="col-3 ">
                            <button class="btn btn-danger " id="buttonCerrartPromo">
                                Cancelar
                            </button>
                        </div>

                    </div>



                    <h3>Elige una fecha Inicio y Fin:</h3>
                    <div class="row text-center mx-3 mb-3">
                        <div class="col-md-6">
                            <label>Fecha inicio</label>
                            <input type="date" class="form-control " name="fechaInicio" id="fechaInicio">
                        </div>

                        <div class="col-md-6">
                            <label>Fecha fin</label>
                            <input type="date" class="form-control" name="fechaFin" id="fechaFin">
                        </div>
                    </div>


                    <h3>Ingrese el descuento:</h3>
                    <div class="row text-center mb-3">
                        <div class="col-md-3">

                            <input type="number" class="form-control " name="fechaInicio" id="descuento">
                        </div>
                    </div>


                    <!-- ACCIONES -->
                    <div class="acciones text-center">
                        <button class="cancelar"
                                id="cerrar-modal">
                            Cancelar
                        </button>
                        <button class="confirmar" id="buttonAplicarDescuentos">
                            Aplicar
                        </button>
                    </div>
                    <div class="alert alert-danger mt-4 text-center d-none mb-0" id="mensaje-error">

                    </div>
                </dialog>
            </div>

            <div></div>

        </div>

        <!-- TABLA -->
        <div class="bg-white p-4 rounded-lg shadow">
            <table id="tablaPromociones" class="table table-striped table-hover table-bordered w-full">
                <thead class="table-dark text-center">
                <tr>
                    <th>ID</th>

                    <th>Producto</th>
                    <th>Descuento</th>
                    <th>Fecha Inicio</th>
                    <th>Fecha Fin</th>
                    <th>Promocion</th>
                    <th>Opciones</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="d : ${listaDescuentos}" class="text-center align-middle">
                    <td th:text="${d.idDescuento}"></td>




                    <td th:each="pr : ${d.producto}" th:text="${pr.nombre}"></td>

                    <td th:text="${(d.porcentajeDescuento * 100).intValue()} + '%'"></td>

                    <td th:text="${#temporals.format(d.fechaInicio, 'yyyy-MM-dd')}"></td>
                    <td th:text="${#temporals.format(d.fechaFin, 'yyyy-MM-dd')}"></td>
                    <td th:each="p : ${d.promocion}" th:text="${p.nombrePromo}"></td>
                    <td>
                        <div class="flex gap-2 justify-center">
                            <a th:href="@{/mantenimientoDescuentos/editar/{id}(id=${d.idDescuento})}"
                               class="btn btn-warning btn-sm">
                                <i class="fa fa-edit"></i>
                            </a>

                            <a th:href="@{/mantenimientoDescuentos/ver/{id}(id=${d.idDescuento})}"
                               class="btn btn-info btn-sm">
                                <i class="fa fa-eye"></i>
                            </a>
                            <a href="#"
                               class="btn btn-sm btn-danger"

                               data-bs-toggle="modal"
                               data-bs-target="#modalEstado"
                               th:data-id="${d.idDescuento}">
                                <i class="fa fa-power-off"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

    </main>

    <div class="modal fade" id="modalEstado" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Confirmar acción</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    ¿Seguro que deseas eliminar este descuento?
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>

                    <a id="btnConfirmarEstado" class="btn btn-danger">
                        Sí
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script th:src="@{/script/descuento-multiple.js}"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

<script>
    document.querySelectorAll('input[type="date"]').forEach(input => {
        input.addEventListener('click', function () {
            this.blur();
            this.showPicker();

        });

    });
    $(document).ready(function () {
        $('#tablaPromociones').DataTable({
            language: {
                url: "//cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json"
            },
            pageLength: 10,
            lengthMenu: [5, 10, 25, 50],
            columnDefs: [
                { orderable: false, targets: [1, 6] }
            ]
        });
    });
	
		function actualizarReloj() {
		    const ahora = new Date();
		    const dia = String(ahora.getDate()).padStart(2, '0');
		    const mes = String(ahora.getMonth() + 1).padStart(2, '0'); // Enero = 0
		    const anio = ahora.getFullYear();
		    const hora = String(ahora.getHours()).padStart(2, '0');
		    const minutos = String(ahora.getMinutes()).padStart(2, '0');
		    const segundos = String(ahora.getSeconds()).padStart(2, '0');
		    document.getElementById('reloj').innerText = `${dia}/${mes}/${anio} ${hora}:${minutos}:${segundos}`;
		}

		// Actualiza cada segundo
		setInterval(actualizarReloj, 1000);
		actualizarReloj(); 
		
		
		document.addEventListener("DOMContentLoaded", function () {

		    const modal = document.getElementById('modalEstado');
		    const btnConfirmar = document.getElementById('btnConfirmarEstado');

		    modal.addEventListener('show.bs.modal', function (event) {
		        const button = event.relatedTarget;
		        const id = button.getAttribute('data-id');


				btnConfirmar.addEventListener('click', function () {
                    try {
                        const response = fetch(`/mantenimientoDescuentos/eliminar/${id}`, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                        .then(res => {
                            if(!res.ok) throw new Error("Error");
                            location.reload();
                        })
                        .catch(err => {
                            console.error(err);
                        });

                    } catch (error) {
                        console.error("Error:", error);
                    }

                });

		    });

		});
</script>

</body>
</html>
